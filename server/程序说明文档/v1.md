<div class="relative"><div class="absolute top-1 right-1 z-10 print:hidden"><div class="flex flex-row gap-0.5"></div></div><div dir="auto" class="table-container relative group/table clear-both overflow-scroll flex flex-row" style=""><div class="scroll-gradient-sentinel" style="height: 100%; width: 1px; left: 0px; flex-shrink: 0;"></div><table dir="auto" class="w-fit min-w-[calc(var(--content-width)-13px)] [&amp;&gt;thead&gt;tr&gt;th:last-child]:pr-8"><thead class="sticky [top:var(--thead-sticky-top)] [&amp;_th]:h-10 [background-color:var(--thead-bg-color)] [box-shadow:0_1px_0_0_var(--thead-border-b-color)] border-b-0" node="[object Object]"><tr class="border-primary/10" node="[object Object]"><th class="break-words" data-col-size="lg" node="[object Object]">需求</th><th class="break-words" data-col-size="xl" node="[object Object]">调用方式</th><th class="break-words" data-col-size="xs" node="[object Object]">重试次数</th><th class="break-words" data-col-size="md" node="[object Object]">超时时间</th><th class="break-words" data-col-size="md" node="[object Object]">代码示例</th></tr></thead><tbody><tr class="border-primary/10" node="[object Object]"><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;"><strong class="font-semibold" node="[object Object]">重试3次（当前默认）</strong></td><td class="break-words" data-col-size="xl" node="[object Object]" style="white-space: pre-wrap;"><span class="text-sm px-1 rounded-sm !font-mono bg-orange-400/10 text-orange-500 dark:bg-orange-300/10 dark:text-orange-300">callWithTimeoutAndRetry(task, 3, 120000)</span></td><td class="break-words" data-col-size="xs" node="[object Object]" style="white-space: pre-wrap;">3次</td><td class="break-words" data-col-size="md" node="[object Object]" style="white-space: pre-wrap;">2分钟</td><td class="break-words" data-col-size="md" node="[object Object]" style="white-space: pre-wrap;">✅ 当前实现</td></tr><tr class="border-primary/10" node="[object Object]"><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;"><strong class="font-semibold" node="[object Object]">重试1次</strong></td><td class="break-words" data-col-size="xl" node="[object Object]" style="white-space: pre-wrap;"><span class="text-sm px-1 rounded-sm !font-mono bg-orange-400/10 text-orange-500 dark:bg-orange-300/10 dark:text-orange-300">callWithTimeoutAndRetry(task, 1, 60000)</span></td><td class="break-words" data-col-size="xs" node="[object Object]" style="white-space: pre-wrap;">1次</td><td class="break-words" data-col-size="md" node="[object Object]" style="white-space: pre-wrap;">1分钟</td><td class="break-words" data-col-size="md" node="[object Object]" style="white-space: pre-wrap;">改参数即可</td></tr><tr class="border-primary/10" node="[object Object]"><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">**<strong class="font-semibold" node="[object Object]">无重试，只超时</strong></td><td class="break-words" data-col-size="xl" node="[object Object]" style="white-space: pre-wrap;"><span class="text-sm px-1 rounded-sm !font-mono bg-orange-400/10 text-orange-500 dark:bg-orange-300/10 dark:text-orange-300">Promise.race([task(signal), timeoutPromise])</span></td><td class="break-words" data-col-size="xs" node="[object Object]" style="white-space: pre-wrap;">0次</td><td class="break-words" data-col-size="md" node="[object Object]" style="white-space: pre-wrap;">可控</td><td class="break-words" data-col-size="md" node="[object Object]" style="white-space: pre-wrap;">手动包装</td></tr><tr class="border-primary/10" node="[object Object]"><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;"><strong class="font-semibold" node="[object Object]">无重试无超时</strong></td><td class="break-words" data-col-size="xl" node="[object Object]" style="white-space: pre-wrap;"><span class="text-sm px-1 rounded-sm !font-mono bg-orange-400/10 text-orange-500 dark:bg-orange-300/10 dark:text-orange-300">await task(null)</span></td><td class="break-words" data-col-size="xs" node="[object Object]" style="white-space: pre-wrap;">0次</td><td class="break-words" data-col-size="md" node="[object Object]" style="white-space: pre-wrap;">无</td><td class="break-words" data-col-size="md" node="[object Object]" style="white-space: pre-wrap;">最简单</td></tr></tbody></table><div class="scroll-gradient-sentinel" style="height: 100%; width: 1px; right: 0px; flex-shrink: 0;"></div></div></div>

---

<table dir="auto" class="w-fit min-w-[calc(var(--content-width)-13px)] [&amp;&gt;thead&gt;tr&gt;th:last-child]:pr-8"><thead class="sticky [top:var(--thead-sticky-top)] [&amp;_th]:h-10 [background-color:var(--thead-bg-color)] [box-shadow:0_1px_0_0_var(--thead-border-b-color)] border-b-0" node="[object Object]"><tr class="border-primary/10" node="[object Object]"><th class="break-words" data-col-size="lg" node="[object Object]">功能</th><th class="break-words" data-col-size="lg" node="[object Object]">axios timeout</th><th class="break-words" data-col-size="lg" node="[object Object]">Promise.race + AbortController</th></tr></thead><tbody><tr class="border-primary/10" node="[object Object]"><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">单次 HTTP 请求超时</td><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">✅</td><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">✅</td></tr><tr class="border-primary/10" node="[object Object]"><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;"><strong class="font-semibold" node="[object Object]">整个任务链超时</strong>（多次模型调用 + 工具执行）</td><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">❌</td><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">✅</td></tr><tr class="border-primary/10" node="[object Object]"><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">主动取消时能立即中断正在进行的 axios 请求</td><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">❌（需要手动传 signal）</td><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">✅（abort() 会触发 signal.abort）</td></tr><tr class="border-primary/10" node="[object Object]"><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">超时后强制抛错，不依赖底层 HTTP 实现</td><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">依赖 node/axios</td><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">完全由 JS setTimeout 控制，更可靠</td></tr><tr class="border-primary/10" node="[object Object]"><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">支持重试逻辑</td><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">❌</td><td class="break-words" data-col-size="lg" node="[object Object]" style="white-space: pre-wrap;">✅（外层 for 循环）</td></tr></tbody></table>


```mermaid

graph TD
    A["用户调用 handleGenerateCode"] --> B{"是单页面重新生成吗？"}

    B -- 是 --> C["创建/更新单页面任务 (taskManager)"]
    B -- 否 --> D{"有批量页面吗？"}

    D -- 是 --> E["为每个页面创建/更新任务 (taskManager)"]
    D -- 否 --> F["返回错误：缺少页面信息"]

    C --> G["异步执行 executeSinglePageGeneration"]
    E --> H["异步执行 executeCodeGeneration"]

    G --> I{"pageQueueManager.addTask(pageId, taskFn)"}
    H --> J{"executeCodeGeneration 内部循环调用 pageQueueManager.addTask"}

    I --> K{"队列中是否存在同 pageId 任务？"}
    J --> K

    K -- 是 --> L["取消旧任务"]
    K -- 否 --> M["将新任务添加到 PQueue"]
    L --> M

    M --> N{"任务开始执行 (generateSinglePageWithSteps)"}
    N --> O["更新任务状态为 'generating'"]

    O --> P{"重试循环 (最多3次)"}
    P --> Q{"检查任务是否被取消 (signal.aborted)"}

    Q -- 是 --> R["抛出 '任务被取消' 错误"]
    Q -- 否 --> S["步骤1: 调用 LLM 总结组件 (callChatCompletion)"]

    S -- LLM超时/失败 --> T["更新任务状态为 'timeout' 或 'fail'"]
    S -- LLM成功 --> U["步骤2: 调用知识库查询组件用法"]

    U -- 知识库失败 --> T
    U -- 知识库成功 --> V["步骤3: 再次调用 LLM 生成页面代码 (callChatCompletion)"]

    V -- LLM超时/失败 --> T
    V -- LLM成功 --> W["步骤4: ESLint 检查生成的代码"]

    W -- ESLint失败 --> T
    W -- ESLint成功 --> X["步骤5: 写入代码到本地磁盘"]

    X -- 写入失败 --> T
    X -- 写入成功 --> Y["更新任务状态为 'complete'"]

    Y --> Z["返回成功结果"]
    T --> Z
    R --> Z

    Z --> AA["executeSinglePageGeneration/executeCodeGeneration 捕获错误并处理"]
    AA --> AB["handleGenerateCode 返回响应"]

```